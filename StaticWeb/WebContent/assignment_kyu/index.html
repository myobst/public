<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Insert title here</title>
	
	<link type="text/css" rel="stylesheet" href="jquery-ui-1.10.3.custom/css/smoothness/jquery-ui-1.10.3.custom.min.css" />
	<link type="text/css" rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/chosen/1.0/chosen.min.css">
	<link type="text/css" rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/qtip2/2.1.0/jquery.qtip.min.css" />
	
	
	<script type="text/javascript" src="http://code.jquery.com/jquery-1.9.1.js"></script>
	<script type="text/javascript" src="jquery-ui-1.10.3.custom/js/jquery-ui-1.10.3.custom.min.js"></script>
	<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true&libraries=geometry"></script>
	
	<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/chosen/1.0/chosen.jquery.min.js"></script>
	<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/qtip2/2.1.0/jquery.qtip.min.js"></script>
	
	<script type="text/javascript">
		var fromCity;
		var toCity;
		var classValue;
		var distance;
		var duration;
		var minDays = 3;
		var noPassportCountryCodes = [ "US", "CN" ];
		var surchargeStates = [ "CA" ];
		var surcharge = 500;
		var totalXHR;
		
		$( document ).ready( function(){
			$( "#lastNameInput" ).change( function(){
				if( $( this ).val().length == 0 ) $( "#lastNameMessage" ).text( "Last name required." ).addClass( "errorMessage" );
				else $( "#lastNameMessage" ).text( "" ).removeClass( "errorMessage" );
			} );
			$( "#firstNameInput" ).change( function(){
				if( $( this ).val().length == 0 ) $( "#firstNameMessage" ).text( "First name required." ).addClass( "errorMessage" );
				else $( "#firstNameMessage" ).text( "" ).removeClass( "errorMessage" );
			} );
			$( "#fromCityInput" ).autocomplete( {
				minLength: 2,
				select: updateFromCity,
				change: updateFromCity,
				source: function( request, response ) {
					$.ajax( {
						url: "http://ws.geonames.org/searchJSON",
						dataType: "jsonp",
						data: { featureClass: "P", style: "medium", lang: "eng", maxRows: 12, name_startsWith: request.term },
						success: function( data ) {
							response( $.map( data.geonames, function( item ) {
								return { label: item.name + ", " + item.adminName1 + " " + item.countryCode, data: item };
							} ) );
						}
					} );
				}
			} );
			$( "#toCityInput" ).autocomplete( {
				minLength: 2,
				select: updateToCity,
				change: updateToCity,
				source: function( request, response ) {
					$.ajax( {
						url: "http://ws.geonames.org/searchJSON",
						dataType: "jsonp",
						data: { featureClass: "P", style: "medium", country: "US", lang: "eng", maxRows: 12, name_startsWith: request.term },
						success: function( data ) {
							response( $.map( data.geonames, function( item ) {
								return { label: item.name + ", " + item.adminName1, data: item };
							} ) );
						}
					} );
				}
			} );
			$( "#fromDateInput" ).datepicker( { 
				minDate: 0, 
				dateFormat: "MM d, yy",
				onSelect: function( dateValue ){
					var minToDate = new Date( dateValue );
					minToDate.setDate( minToDate.getDate() + minDays );
					$( "#toDateInput" ).datepicker( "option", "minDate", minToDate );
					
					updateDuration();
				}
			} );
			$( "#toDateInput" ).datepicker( { 
				minDate: minDays, 
				dateFormat: "MM d, yy",
				onSelect: updateDuration
			} ); 
			$( "#classSelect" ).change( function( event ) {
				classValue = $( this ).val();
				
				if( classValue ){
					$( "#classMessage" ).text( "" ).removeClass( "errorMessage" );
					$( "#classDisplay" ).text( classValue.toString() + " per mile day" );
				}else{
					$( "#classMessage" ).text( "Class required" ).addClass( "errorMessage" );
					$( "#classDisplay" ).text( "" );
				}
				
				updateTotal();
			} );
			$( "#travelersInput" ).spinner( { 
				min: 1, 
				max: 10,
				stop: updateTotal
			} );
			$( "#travelform" )[ 0 ].reset();
			$( "input, select" ).addClass( "ui-corner-all" );
		} );
		function updateFromCity( event, ui ){
			var _fromCity = ui.item ? ui.item.data : null;
			if( _fromCity && fromCity && _fromCity.geonameId == fromCity.geonameId ) return;

			fromCity = _fromCity;
			if( fromCity ){
				if( noPassportCountryCodes.indexOf( fromCity.countryCode ) > -1 ) $( "#fromCityMessage" ).text( "No Passport Required" ).removeClass( "errorMessage" );
				else $( "#fromCityMessage" ).text( "Passport Required" ).removeClass( "errorMessage" );
			}else{
				$( this ).val( $( this ).val().split( "," )[ 0 ] );
				$( "#fromCityMessage" ).text( "Departure city required" ).addClass( "errorMessage" );
			}
			updateDistance();
		}
		function updateToCity( event, ui ){
			var _toCity = ui.item ? ui.item.data : null;
			if( _toCity && toCity && _toCity.geonameId == toCity.geonameId ) return;

			toCity = _toCity;
			if( toCity ){
				if( surchargeStates.indexOf( toCity.adminCode1 ) > -1 ) $( "#toCityMessage" ).text( "$" + surcharge + " surcharge for " + toCity.adminName1 ).removeClass( "errorMessage" );
				else $( "#toCityMessage" ).text( "" ).removeClass( "errorMessage" );
			}else{
				$( this ).val( $( this ).val().split( "," )[ 0 ] );
				$( "#toCityMessage" ).text( "Destination city required" ).addClass( "errorMessage" );
			}
			updateDistance();
		}
		function updateDistance(){
			if( fromCity && toCity ){
				_distance = google.maps.geometry.spherical.computeDistanceBetween( new google.maps.LatLng( fromCity.lat, fromCity.lng ), new google.maps.LatLng( toCity.lat, toCity.lng ) ) * 0.000621371;
				$( "#distanceDisplay" ).text( parseFloat( _distance ).toFixed( 2 ) + " miles" );
			}else{
				_distance = null;
				$( "#distanceDisplay" ).text( "" );
			}
			if( _distance == distance ) return;
			
			distance = _distance;
			updateTotal();
		}
		function updateDuration(){
			var fromDate = $( "#fromDateInput" ).datepicker( "getDate" );
			var toDate = $( "#toDateInput" ).datepicker( "getDate" );
			if( fromDate && toDate ){
				_duration = Math.round( ( toDate - fromDate ) / 86400000 );
				$( "#durationDisplay" ).text( _duration.toString() + " days" );
			}else{
				_duration = null;
				$( "#durationDisplay" ).text( "" );
			}
			if( _duration == duration ) return;
			
			duration = _duration;
			updateTotal();
		}
		function updateTotal(){
			if( totalXHR && totalXHR.readyState != 4 && totalXHR.readyState != 0 ){
				console.log( "aborting" );
				totalXHR.abort();
			}
			
			if( !distance || !duration || !classValue ){
                $( "#totalDisplay" ).removeClass( "loading" );
				$( "#totalDisplay" ).text( "--" );
				
				return;
			}

			var submitData = "distance=" + distance + "&duration=" + duration + "&classValue=" + classValue + "&travelers=" + $( "#travelersInput" ).val();
			if( surchargeStates.indexOf( toCity.adminCode1 ) > -1 ) submitData += "&surcharge=" + surcharge;

			console.log( "sending" );
			totalXHR = $.ajax( {
				url: "http://localhost/slop/Handler.ashx",
				dataType: "jsonp",
				data: submitData, 
				beforeSend: function(){
					$( "#totalDisplay" ).text( "" );
                    $( "#totalDisplay" ).addClass( "loading" );
				},
				success: function( resultData ) {
					console.log( "processing" );
	                $( "#totalDisplay" ).removeClass( "loading" );
					$( "#totalDisplay" ).text( "$" +( resultData.total ).toFixed( 2 ) ); 
				}
			} );
		}
	</script>
	<style type="text/css">
		body {
			font-size: 1.25em;
			background-color: #eeeeee;
			min-width: 640px;
		}
		.labelCol {
			margin: 4px;
 			padding: 4px;
			display: inline-block;
			width: 15%;
			text-align: right;
			float: left;
		}
		.inputCol {
 			margin: 4px; 
 			padding: 4px;
			display: inline-block;
 			box-sizing: border-box;
 			-moz-box-sizing: border-box;
 			-webkit-box-sizing: border-box;
			width: 40%;
			max-width: 400px;
			font-size: 1em;
		}
		.messageCol {
			margin: 4px;
 			padding: 4px;
			display: inline-block;
			width: 10%;
		}		
		.totalCol {
			margin: 4px 100px 4px 4px;
 			padding: 4px;
			display: inline-block;
			float: right; 
			width: 20%;
			border-bottom: 1px dashed grey;
			color: green;
		}
		div.formItem {
			margin: 4px;
 			padding: 4px;
		}
		.errorMessage {
			color: red;
		}
		.loading {
			display: block;
 			background: url(circle.gif) no-repeat;
			min-width: 32px;
			min-height: 32px;
		}
	</style>
</head>
<body>
	<form id="travelform">
			<div class="formItem">
				<label class="labelCol" for="lastNameLabel">Last Name:</label>
				<input class="inputCol" type="text" id="lastNameInput" value="" />
				<div class="messageCol" id="lastNameMessage"></div>
			</div>
			<div class="formItem">
				<label class="labelCol" for="firstNameLabel">First Name:</label>
				<input class="inputCol" type="text" id="firstNameInput" value="" />
				<div class="messageCol" id="firstNameMessage"></div>
			</div>
			<div class="formItem" id="fromCityDisplay">
				<label class="labelCol" for="fromCityLabel">From City:</label>
				<input class="inputCol" type="text" id="fromCityInput" value="" />
				<div class="messageCol" id="fromCityMessage"></div>
			</div>
			<div class="formItem">
				<label class="labelCol" for="toCityInput">To City:</label>
				<input class="inputCol" type="text" id="toCityInput" value="" />
				<div class="messageCol" id="toCityMessage"></div>
				<div class="totalCol" id="distanceDisplay"></div>
			</div>
			<div class="formItem">
				<label class="labelCol" for="fromDateInput">From Date:</label>
				<input class="inputCol" type="text" class="date" id="fromDateInput" readonly="readonly" />
			</div>
			<div class="formItem">
				<label class="labelCol" for="toDateInput">To Date:</label>
				<input class="inputCol" type="text" class="date" id="toDateInput" readonly="readonly" />
				<div class="totalCol" id="durationDisplay"></div>
			</div>
			<div class="formItem">
				<label class="labelCol" for="classSelect">First Class:</label>
				<select class="inputCol" id="classSelect">
					<option value="">Select...</option>
					<option value="0.99">Economy</option>
					<option value="1.99">Business</option>
					<option value="2.99">First</option>
				</select>
				<div class="messageCol" id="classMessage"></div>
				<div class="totalCol" id="classDisplay"></div>
			</div>
			<div class="formItem">
				<label class="labelCol" for="travelersInput">Travelers:</label>
				<input class="inputCol" type="text" id="travelersInput" value="1" readonly="readonly" />
				<div class="totalCol" id="totalDisplay"></div>
			</div>
	</form>
	<div id="total"></div>
</body>
</html>